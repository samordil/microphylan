/*
* --------------------------------------------------------------
*   KWTRP HPC profile for Microphylan
* --------------------------------------------------------------
*/

params {
    config_profile_name        = 'kemri'
    config_profile_description = 'KWTRP HPC profile for Microphylan pipeline'
    config_profile_contact     = 'Samuel Odoyo (@sodoyo)'
    config_profile_url         = 'kwtrp-peo github page'

    apptainer_cache_dir        = "/scratch/.apptainerCache"
}

// Use SLURM for job submission
executor {
    name            = 'slurm'
    queueSize       = 20
    submitRateLimit = '6/1min'
}

// Enable Apptainer (Singularity) runtime
apptainer {
    enabled    = true
    autoMounts = true
    cacheDir   = params.apptainer_cache_dir
}

// Process configuration for HPC execution
process {
    scratch = true
    cache   = 'deep'

    // Activate Apptainer conda environment inside every job (only if available)
    beforeScript = '''
    if command -v conda &> /dev/null; then
        eval "$(conda shell.bash hook)" && conda activate apptainer-env
    fi
    '''

    // Retry and error handling
    maxRetries = 3
    errorStrategy = { task.attempt <= 3 ? 'retry' : 'finish' }

    // Check queue status every 10 minutes
    queueStatInterval = '10 min'

    // Assign partitions based on labels (not memory closures)
    withLabel:process_high_memory {
        queue = 'highmem'
    }
    withLabel:process_long {
        queue = 'longrun'
    }
    withLabel:gpu {
        queue = 'gpu'
    }

    // Default fallback queue
    queue = 'highmem'
}
